Here is a SQL Query of a common table expression for average amount paid by top 5 customers

WITH	average(first_name, last_name, customer_id, country, total_amount_paid)	AS
(SELECT	c.first_name,
c.last_name,
c.customer_id,
f.country,
SUM(amount)	AS	total_amount_paid
FROM	payment	a
INNER	JOIN	rental	b	ON	a.rental_id	=	b.rental_id
INNER	JOIN	customer	c	ON	b.customer_id	=	c.customer_id
INNER	JOIN	address	d	ON	c.address_id	=	d.address_id
INNER	JOIN	city	e	ON	d.city_id	=	e.city_id
INNER	JOIN	country	f	ON	e.country_id	=	f.country_id
WHERE	city	IN	('Aurora','Atlixco','Zalantun','Pontianak','Tarsus','Aparecida	
de
Goinia','Emeishan','Rio	Claro','Yingkou','Tokat')
GROUP	BY	c.first_name,	c.last_name,f.country,c.customer_id
ORDER	BY	total_amount_paid	DESC
LIMIT	5)
SELECT	AVG(total_amount_paid) AS average_amount_paid
FROM	average
